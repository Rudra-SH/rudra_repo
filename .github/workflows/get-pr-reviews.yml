name: Get PR Reviews

on:
  workflow_dispatch:

jobs:
  fetch-pr-reviews:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch PRs and their reviews
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: 'backstage'
          REPO: 'bacckstage'
        uses: actions/github-script@v7
        with:
          script: |
            node <<'EOF'
            const fetch = require('node-fetch');
  
            const owner = process.env.OWNER;
            const repo = process.env.REPO;
            const token = process.env.GITHUB_TOKEN;
            const limit = 5; // Concurrency limit
  
            async function fetchPullRequests() {
              const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/pulls`, {
                headers: { Authorization: `Bearer ${token}` }
              });
              if (!res.ok) throw new Error(`Failed to fetch PRs: ${res.statusText}`);
              return res.json();
            }
  
            async function fetchReviews(pr) {
              const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/pulls/${pr.number}/reviews`, {
                headers: { Authorization: `Bearer ${token}` }
              });
              if (!res.ok) throw new Error(`Failed to fetch reviews for PR #${pr.number}`);
              return res.json();
            }
  
            async function runWithConcurrencyLimit(tasks, limit) {
              const results = [];
              const executing = [];
  
              for (const task of tasks) {
                const p = task();
                results.push(p);
  
                const e = p.then(() => executing.splice(executing.indexOf(e), 1));
                executing.push(e);
  
                if (executing.length >= limit) {
                  await Promise.race(executing);
                }
              }
  
              return Promise.all(results);
            }
  
            (async () => {
              const pullRequests = await fetchPullRequests();
  
              if (pullRequests.length === 0) {
                console.log("No open pull requests found.");
                return;
              }
  
              const tasks = pullRequests.map(pr => () => fetchReviews(pr));
              const reviewsPerPR = await runWithConcurrencyLimit(tasks, limit);
  
              pullRequests.forEach((pr, i) => {
                console.log(`\nPR #${pr.number} - ${pr.title}`);
                if (reviewsPerPR[i].length === 0) {
                  console.log("  No reviews");
                } else {
                  reviewsPerPR[i].forEach(review => {
                    console.log(`  ${review.user.login}: ${review.state}`);
                  });
                }
              });
            })().catch(err => {
              console.error("Workflow failed:", err);
              process.exit(1);
            });
            EOF
